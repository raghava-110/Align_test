name: Auto Run & Self-Heal Selenium Tests

on:
  push:
    paths:
      - '**_automation_*/**'
  workflow_dispatch:

jobs:
  test-and-heal:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install Chrome & ChromeDriver
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
          sudo apt-get update
          sudo apt-get install google-chrome-stable -y

          wget -q https://storage.googleapis.com/chrome-for-testing-public/131.0.6778.87/linux64/chromedriver-linux64.zip
          unzip -q chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Download Selenium JAR & Dependencies
        run: |
          mkdir -p lib
          wget -q https://github.com/SeleniumHQ/selenium/releases/download/selenium-4.15.0/selenium-server-4.15.0.jar -O lib/selenium-server.jar
          wget -q https://repo1.maven.org/maven2/org/apache/poi/poi/5.2.3/poi-5.2.3.jar -O lib/poi.jar
          wget -q https://repo1.maven.org/maven2/org/apache/poi/poi-ooxml/5.2.3/poi-ooxml-5.2.3.jar -O lib/poi-ooxml.jar
          wget -q https://repo1.maven.org/maven2/org/apache/commons/commons-collections4/4.4/commons-collections4-4.4.jar -O lib/commons-collections4.jar
          wget -q https://repo1.maven.org/maven2/org/apache/xmlbeans/xmlbeans/5.1.1/xmlbeans-5.1.1.jar -O lib/xmlbeans.jar
          wget -q https://repo1.maven.org/maven2/org/apache/commons/commons-compress/1.21/commons-compress-1.21.jar -O lib/commons-compress.jar

      - name: Find Automation Directory
        id: find-dir
        run: |
          DIR=$(find . -type d -name "*_automation_*" | head -1)
          if [ -z "$DIR" ]; then
            echo "Error: No automation directory found"
            exit 1
          fi
          echo "script_dir=$DIR" >> $GITHUB_OUTPUT
          echo "Found directory: $DIR"

      - name: Compile Java Code
        id: compile
        continue-on-error: true
        run: |
          DIR="${{ steps.find-dir.outputs.script_dir }}"
          cd "$DIR"
          JAVA_FILE=$(ls *.java 2>/dev/null | head -1)
          echo "Compiling: $JAVA_FILE"
          javac -cp "$GITHUB_WORKSPACE/lib/*:." $JAVA_FILE 2>&1 | tee compile.log

      - name: Run Selenium Tests
        id: test
        if: steps.compile.outcome == 'success'
        continue-on-error: true
        run: |
          DIR="${{ steps.find-dir.outputs.script_dir }}"
          cd "$DIR"

          CLASS_NAME=$(ls *.java | sed 's/.java//')
          echo "Running: $CLASS_NAME"

          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &

          timeout 600 java -cp "$GITHUB_WORKSPACE/lib/*:." $CLASS_NAME > test_output.log 2>&1
          TEST_EXIT=$?

          cat test_output.log
          exit $TEST_EXIT

      - name: Check Results & Self-Heal
        if: steps.compile.outcome == 'failure' || steps.test.outcome == 'failure'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          DIR="${{ steps.find-dir.outputs.script_dir }}"

          echo "=========================================="
          echo "TEST FAILURE DETECTED"
          echo "=========================================="

          # Get error logs
          if [ -f "$DIR/compile.log" ]; then
            ERROR_LOG=$(cat "$DIR/compile.log")
          elif [ -f "$DIR/test_output.log" ]; then
            ERROR_LOG=$(cat "$DIR/test_output.log")
          else
            ERROR_LOG="Unknown error"
          fi

          # Check retry count
          RETRY_COUNT_FILE=".github/retry_count"
          if [ -f "$RETRY_COUNT_FILE" ]; then
            RETRY_COUNT=$(cat "$RETRY_COUNT_FILE")
          else
            RETRY_COUNT=0
          fi

          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo $RETRY_COUNT > $RETRY_COUNT_FILE

          echo "Retry attempt: $RETRY_COUNT / 3"

          if [ $RETRY_COUNT -le 3 ] && [ -n "$GEMINI_API_KEY" ]; then
            echo "ðŸ”§ Self-healing: Regenerating code..."

            # Read context files
            TEST_CASES=$(cat "$DIR/test_cases.json")
            XPATH_MAPPINGS=$(cat "$DIR/xpath_mappings.json")

            # Create prompt for Gemini
            PROMPT="You are a Selenium automation expert. Fix this Java code based on errors.

          TEST CASES:
          $TEST_CASES

          XPATH MAPPINGS:
          $XPATH_MAPPINGS

          ERRORS (Attempt $RETRY_COUNT):
          $ERROR_LOG

          FIXES NEEDED:
          - If ElementNotFoundException: Add 8-10 XPath fallback strategies
          - If TimeoutException: Increase waits to 30 seconds
          - If StaleElementException: Re-find element before interaction
          - If ClickInterceptedException: Use JavaScript click
          - If compilation errors: Fix syntax and imports
          - Add extensive try-catch with retries

          Generate ONLY the complete fixed Java Selenium code. No explanations, just code."

            # Call Gemini API (using gemini-2.5-pro - same as code generation)
            echo "Calling Gemini API (gemini-2.5-pro)..."
            RESPONSE=$(curl -s -X POST \
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=$GEMINI_API_KEY" \
              -H 'Content-Type: application/json' \
              -d "{\"contents\":[{\"parts\":[{\"text\":$(echo "$PROMPT" | jq -Rs .)}]}]}")

            # Debug: Show API response
            echo "Gemini API Response:"
            echo "$RESPONSE" | jq '.' || echo "$RESPONSE"

            # Extract code
            FIXED_CODE=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

            echo "Extracted code length: ${#FIXED_CODE}"

            if [ -n "$FIXED_CODE" ]; then
              # Remove markdown if present
              echo "$FIXED_CODE" | sed -n '/```java/,/```/p' | sed '1d;$d' > "$DIR/selenium_code.java" || \
              echo "$FIXED_CODE" > "$DIR/selenium_code.java"

              echo "âœ“ Code regenerated"

              # Commit and push
              git config user.name "GitHub Actions Bot"
              git config user.email "actions@github.com"
              git add "$DIR/selenium_code.java"
              git commit -m "ðŸ¤– Auto-fix: Regenerated code (Attempt $RETRY_COUNT)"
              git push

              echo "âœ“ Fixed code pushed. Tests will re-run automatically."
            else
              echo "âœ— Failed to regenerate code"
              exit 1
            fi
          else
            if [ -z "$GEMINI_API_KEY" ]; then
              echo "âš  GEMINI_API_KEY secret not set - cannot self-heal"
            else
              echo "âš  Max retries (3) reached"
            fi
            exit 1
          fi

      - name: Success Notification
        if: steps.test.outcome == 'success'
        run: |
          echo "=========================================="
          echo "âœ… ALL TESTS PASSED!"
          echo "=========================================="
          rm -f .github/retry_count
